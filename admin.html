<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Tailwind CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Chart.js from CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- LeafletJS CSS from CDN for the map picker -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Custom CSS for transitions and minor tweaks */
        .modal-overlay, .toast { transition: opacity 0.3s ease-in-out; }
        .modal-container { transition: transform 0.3s ease-in-out; }
        .toast-enter { opacity: 0; transform: translateY(20px); }
        .toast-leave { opacity: 0; transform: translateY(-20px); }
        .dark .dark-bg-gray-800 { background-color: #1a202c; }
        .dark .dark-bg-gray-900 { background-color: #171923; }
        .dark .dark-text-gray-200 { color: #edf2f7; }
        .dark .dark-text-gray-400 { color: #a0aec0; }
        .dark .dark-border-gray-700 { border-color: #4a5568; }
        .message-bot { background-color: #E2E8F0; }
        .dark .message-bot { background-color: #4A5568; }
        .message-user { background-color: #DBEAFE; }
        .dark .message-user { background-color: #2B6CB0; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans">
    <!-- Main application container -->
    <div class="flex h-screen bg-gray-200 dark:bg-gray-800">
        <!-- Collapsible Sidebar -->
        <div id="sidebar" class="w-64 bg-gray-800 dark:bg-gray-900 text-white p-4 fixed inset-y-0 left-0 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Admin Panel</h2>
            <nav>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 dark:hover:bg-gray-700" data-page="dashboard">Dashboard</a>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 dark:hover:bg-gray-700" data-page="destinations">Destinations</a>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-page="hotels">Hotels</a>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-page="foods">Foods</a>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-page="traditions">Traditions</a>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-page="bookings">Bookings</a>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-page="users">Users</a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div id="main-container" class="flex-1 flex flex-col overflow-hidden transition-all duration-300 ease-in-out">
            <!-- Header -->
            <header class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 border-b-2 border-gray-200 dark:border-gray-700">
                <div class="flex items-center">
                    <button id="menu-button" class="text-gray-500 dark:text-gray-400 focus:outline-none" aria-label="Open menu">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200 ml-4" id="page-title">Destinations</h1>
                </div>
                <div class="flex items-center">
                    <button id="theme-toggle" class="focus:outline-none p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Theme Toggle">
                        <!-- Moon Icon -->
                        <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        <!-- Sun Icon -->
                        <svg id="theme-icon-light" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    </button>
                </div>
            </header>
            <!-- Main content rendered by JavaScript -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-4" id="main-content"></main>
        </div>
    </div>
    
    <!-- Reusable UI Components -->

    <!-- Modal for Create/Edit operations -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden modal-overlay"><div class="fixed inset-0 flex items-center justify-center p-4"><div id="modal-container" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl transform -translate-y-full"><div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-2xl font-bold dark:text-gray-200" id="modal-title"></h3><button id="modal-close-button" class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-3xl">&times;</button></div><div class="p-6 overflow-y-auto" style="max-height: 80vh;"><form id="modal-form"></form></div></div></div></div>
    
    <!-- Confirmation Dialog for delete operations -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden modal-overlay"><div class="fixed inset-0 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm"><div class="p-6"><h3 class="text-xl font-bold mb-4 dark:text-gray-200" id="confirmation-title">Are you sure?</h3><p id="confirmation-message" class="dark:text-gray-400"></p></div><div class="flex justify-end gap-4 p-4 bg-gray-100 dark:bg-gray-900 rounded-b-lg"><button id="confirmation-cancel-button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancel</button><button id="confirmation-confirm-button" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Confirm</button></div></div></div></div>
    
    <!-- Container for Toast Notifications -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>
    
    <!-- Loading State Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-25 z-50 hidden items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div></div>

    <!-- Chatbot -->
    <button id="chatbot-toggle" class="fixed bottom-8 right-8 bg-blue-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl z-50 hover:bg-blue-600 transition-transform transform hover:scale-110">
        ðŸ¤–
    </button>
    <div id="chatbot-window" class="hidden fixed bottom-28 right-8 w-96 h-[600px] bg-white dark:bg-gray-800 rounded-lg shadow-2xl flex flex-col z-50">
        <div class="p-4 bg-blue-500 text-white rounded-t-lg">
            <h3 class="text-lg font-semibold">Admin Assistant</h3>
        </div>
        <div id="chatbot-messages" class="flex-1 p-4 overflow-y-auto">
            <!-- Messages will be injected here -->
        </div>
        <div class="p-4 border-t dark:border-gray-700">
            <div class="flex gap-2">
                <input type="text" id="chatbot-input" class="w-full p-2 border dark:border-gray-700 rounded bg-gray-100 dark:bg-gray-900 dark:text-gray-200" placeholder="Ask for a summary...">
                <button id="chatbot-send" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Send</button>
            </div>
        </div>
    </div>

    <!-- LeafletJS for map picker -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Wait for the DOM to be fully loaded before running the script
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DATA STRUCTURE & STORAGE ---
            // This 'db' object simulates a backend database. All data is stored in local memory.
            // In a real application, you would fetch this data from an API.
            // Each key ('destinations', 'hotels', etc.) corresponds to a page and a data table.
            // To add or modify fields, simply update the objects within these arrays.
            // For example, to add a 'price' field to destinations, you would change:
            // { id: 1, name: "Uluwatu Temple", ... } 
            // to:
            // { id: 1, name: "Uluwatu Temple", price: 50000, ... }
            // Then, you would need to update the `renderListPage` function to display the new field
            // in the table and the `handleOpenModal` function to add a form input for it.
            const db = {
                destinations: [
                    { id: 1, name: "Uluwatu Temple", category: "Culture", image: "https://images.unsplash.com/photo-1537996194471-e657df975ab4?w=800", description: "A beautiful temple on a cliff.", rating: 5, lat: -8.829, lng: 115.085 },
                    { id: 2, name: "Seminyak Beach", category: "Beach", image: "https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=800", description: "Popular beach with great nightlife.", rating: 4, lat: -8.692, lng: 115.166 }
                ],
                hotels: [
                    { id: 1, name: "The Mulia Bali", category: "Resort", image: "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=800", description: "Luxurious resort in Nusa Dua.", rating: 5, lat: -8.805, lng: 115.223 },
                    { id: 2, name: "Four Seasons Sayan", category: "Luxury", image: "https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800", description: "Jungle paradise in Ubud.", rating: 5, lat: -8.508, lng: 115.244 }
                ],
                foods: [
                    { id: 1, name: "Babi Guling", category: "Traditional", image: "https://images.ctfassets.net/dsbipkqphva2/72JUsAlJ4IMn0Lsi7vpvEz/36de9180b101d808630599eadce4f40c/best-babi-guling-bali-lead.jpg", description: "Suckling pig, a Balinese delicacy.", rating: 5, lat: -8.653, lng: 115.217 }
                ],
                traditions: [
                    { id: 1, name: "Nyepi", category: "Ceremony", image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwZuVOXAw9ZVPGSVJSXT61HOCzym62sDL5UA&s", description: "The Balinese Day of Silence.", rating: 5, lat: -8.671, lng: 115.212 }
                ],
                bookings: [
                    { id: 1, name: "John Doe - The Mulia Bali", category: "Hotel", image: "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=800", description: "Booking for 2 nights, deluxe room.", rating: 5, lat: -8.805, lng: 115.223 },
                    { id: 2, name: "Jane Smith - Uluwatu Temple Tour", category: "Tour", image: "https://images.unsplash.com/photo-1537996194471-e657df975ab4?w=800", description: "Private tour for a group of 4.", rating: 4, lat: -8.829, lng: 115.085 }
                ],
                users: [
                    { id: 1, name: "Alice Johnson", email: "alice@example.com", signupDate: "2023-01-15", lastLogin: "2023-06-20", status: "Active" },
                    { id: 2, name: "Bob Williams", email: "bob@example.com", signupDate: "2023-02-20", lastLogin: "2023-06-18", status: "Inactive" },
                    { id: 3, name: "Charlie Brown", email: "charlie@example.com", signupDate: "2023-03-10", lastLogin: "2023-06-22", status: "Active" },
                    { id: 4, name: "Diana Miller", email: "diana@example.com", signupDate: "2023-04-05", lastLogin: "2023-06-21", status: "Active" }
                ],
                analytics: {
                    siteVisits: { labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"], data: [1200, 1900, 3000, 5000, 2300, 3200] },
                    subscriptions: { labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"], data: [50, 75, 120, 180, 150, 210] },
                    revenue: { labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"], data: [500, 750, 1200, 1800, 1500, 2100] }
                }
            };

            // --- APPLICATION STATE ---
            // This object holds the current UI state. It helps manage things like the active page,
            // search terms, and pagination, keeping the logic separate from the DOM.
            const appState = {
                currentPage: 'dashboard',
                searchTerm: '',
                filterCategory: '',
                currentPageNumber: 1,
                itemsPerPage: 5,
                editingId: null, // Holds the ID of the item being edited, or null for creating new
            };

            // --- DOM ELEMENT REFERENCES ---
            // Caching DOM elements for quicker access.
            const sidebar = document.getElementById('sidebar'), menuButton = document.getElementById('menu-button'), navLinks = document.querySelectorAll('#sidebar nav a'), pageTitle = document.getElementById('page-title'), mainContent = document.getElementById('main-content'), modal = document.getElementById('modal'), modalContainer = document.getElementById('modal-container'), modalCloseButton = document.getElementById('modal-close-button');

            let activeCharts = []; // To hold active chart instances
            // --- UI COMPONENT FUNCTIONS ---

            /**
             * Displays a toast notification at the bottom-right of the screen.
             * @param {string} message The text to display in the toast.
             * @param {string} [type='success'] The type of toast ('success' or 'error'), which determines its color.
             */
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast text-white px-6 py-3 rounded-lg shadow-md mb-2 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} toast-enter`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.remove('toast-enter'), 10);
                setTimeout(() => {
                    toast.classList.add('toast-leave');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }
            
            /**
             * Shows a modal confirmation dialog.
             * @param {string} message The message to display in the dialog.
             * @param {function} onConfirm A callback function to execute if the user clicks "Confirm".
             */
            function showConfirmation(message, onConfirm) {
                const modal = document.getElementById('confirmation-modal');
                document.getElementById('confirmation-message').textContent = message;
                modal.classList.remove('hidden');

                const confirmButton = document.getElementById('confirmation-confirm-button');
                const cancelButton = document.getElementById('confirmation-cancel-button');

                const handleConfirm = () => {
                    onConfirm();
                    cleanup();
                };

                const cleanup = () => {
                    modal.classList.add('hidden');
                    confirmButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', cleanup);
                };

                confirmButton.addEventListener('click', handleConfirm);
                cancelButton.addEventListener('click', cleanup);
            }
            
            /**
             * Toggles the visibility of the loading overlay.
             * @param {boolean} isLoading If true, shows the loader; if false, hides it.
             */
            function setLoading(isLoading){const o=document.getElementById('loading-overlay');o.classList.toggle('hidden',!isLoading);o.classList.toggle('flex',isLoading)}

            // --- GENERIC RENDERING LOGIC ---

            /**
             * The main render function. It clears the content and calls the page-specific renderer.
             */
            const render = () => {
                const pageKey = appState.currentPage;
                const title = pageKey.charAt(0).toUpperCase() + pageKey.slice(1);
                pageTitle.textContent = title;
                mainContent.innerHTML = ''; // Clear previous content
                
                // Reset filters when switching pages
                appState.searchTerm = ''; appState.filterCategory = ''; appState.currentPageNumber = 1;
                
                if (pageKey === 'dashboard') {
                    renderDashboardPage();
                } else if (pageKey === 'users') {
                    renderUserPage();
                } else {
                    renderListPage();
                }
            };

            const destroyCharts = () => {
                activeCharts.forEach(chart => chart.destroy());
                activeCharts = [];
            };

            function renderUserPage() {
                destroyCharts();
                const users = db.users;
                const activeUsers = users.filter(u => u.status === 'Active').length;
                const inactiveUsers = users.length - activeUsers;

                mainContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">User Status</h3>
                            <canvas id="userStatusChart"></canvas>
                        </div>
                    </div>
                    <!-- User Table -->
                    <div class="bg-white dark:bg-gray-800 shadow-md rounded overflow-x-auto">
                        <table class="min-w-full bg-white dark:bg-gray-800">
                            <thead class="bg-gray-800 dark:bg-gray-900 text-white">
                                <tr>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Name</th>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Email</th>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Signup Date</th>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Status</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700 dark:text-gray-200">
                                ${users.map(user => `
                                    <tr>
                                        <td class="text-left py-3 px-4">${user.name}</td>
                                        <td class="text-left py-3 px-4">${user.email}</td>
                                        <td class="text-left py-3 px-4">${user.signupDate}</td>
                                        <td class="text-left py-3 px-4">
                                            <span class="px-2 py-1 font-semibold leading-tight ${
                                                user.status === 'Active' ? 'text-green-700 bg-green-100' : 'text-red-700 bg-red-100'
                                            } rounded-full dark:bg-opacity-50">
                                                ${user.status}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                const userStatusChart = new Chart(document.getElementById('userStatusChart').getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Active', 'Inactive'],
                        datasets: [{
                            data: [activeUsers, inactiveUsers],
                            backgroundColor: ['#10B981', '#EF4444'],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#FFF' : '#000',
                                }
                            }
                        }
                    }
                });
                activeCharts.push(userStatusChart);
            }
            
            /**
             * Renders the Analytics Dashboard page with charts.
             */
            function renderDashboardPage() {
                destroyCharts();
                const analyticsData = db.analytics;
                mainContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Total Site Visits</h3><p class="text-4xl font-bold text-blue-500">${analyticsData.siteVisits.data.reduce((a, b) => a + b, 0).toLocaleString()}</p></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Total Subscriptions</h3><p class="text-4xl font-bold text-green-500">${analyticsData.subscriptions.data.reduce((a, b) => a + b, 0).toLocaleString()}</p></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Total Revenue</h3><p class="text-4xl font-bold text-yellow-500">$${analyticsData.revenue.data.reduce((a, b) => a + b, 0).toLocaleString()}</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Site Visits Over Time</h3><canvas id="siteVisitsChart"></canvas></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Revenue Growth</h3><canvas id="revenueChart"></canvas></div>
                    </div>
                `;

                const isDarkMode = document.documentElement.classList.contains('dark');
                const chartOptions = {
                    scales: {
                        y: { ticks: { color: isDarkMode ? '#FFF' : '#000' } },
                        x: { ticks: { color: isDarkMode ? '#FFF' : '#000' } }
                    },
                    plugins: { legend: { labels: { color: isDarkMode ? '#FFF' : '#000' } } }
                };

                const siteVisitsChart = new Chart(document.getElementById('siteVisitsChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: analyticsData.siteVisits.labels,
                        datasets: [{ label: 'Visits', data: analyticsData.siteVisits.data, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1, tension: 0.3 }]
                    },
                    options: chartOptions
                });
                activeCharts.push(siteVisitsChart);

                const revenueChart = new Chart(document.getElementById('revenueChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: analyticsData.revenue.labels,
                        datasets: [{ label: 'Revenue ($)', data: analyticsData.revenue.data, backgroundColor: 'rgba(255, 206, 86, 0.2)', borderColor: 'rgba(255, 206, 86, 1)', borderWidth: 1 }]
                    },
                    options: chartOptions
                });
                activeCharts.push(revenueChart);
            }

            /**
             * Renders the entire UI for the current page, including the header, search/filter controls,
             * the data table, and pagination. This function is generic and works for any data type.
             */
            function renderListPage() {
                const pageKey = appState.currentPage;
                const pageTitle = pageKey.charAt(0).toUpperCase() + pageKey.slice(1);
                
                const allItems = db[pageKey]
                    .filter(item => item.name.toLowerCase().includes(appState.searchTerm.toLowerCase()))
                    .filter(item => appState.filterCategory === '' || item.category === appState.filterCategory);

                const paginatedItems = allItems.slice((appState.currentPageNumber - 1) * appState.itemsPerPage, appState.currentPageNumber * appState.itemsPerPage);
                const categories = [...new Set(db[pageKey].map(item => item.category))];
                
                mainContent.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 class="text-3xl font-bold dark:text-gray-200">Manage ${pageTitle}</h2>
                        <div class="flex gap-2">
                            <button id="add-new-button" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add New</button>
                            <div class="relative">
                                <button id="export-button" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Export</button>
                                <div id="export-options" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-20">
                                    <a href="#" id="export-pdf" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Export as PDF</a>
                                    <a href="#" id="export-excel" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Export as Excel</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <input id="search-input" type="text" placeholder="Search by name..." class="p-2 border dark:border-gray-700 rounded w-full md:w-auto md:flex-grow bg-white dark:bg-gray-800 dark:text-gray-200" value="${appState.searchTerm}">
                        <select id="filter-select" class="p-2 border dark:border-gray-700 rounded w-full md:w-auto bg-white dark:bg-gray-800 dark:text-gray-200"><option value="">All Categories</option>${categories.map(c => `<option value="${c}" ${appState.filterCategory === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                    </div>
                    <div class="bg-white dark:bg-gray-800 shadow-md rounded overflow-x-auto">
                        <table class="min-w-full bg-white dark:bg-gray-800">
                            <thead class="bg-gray-800 dark:bg-gray-900 text-white"><tr><th class="w-1/3 text-left py-3 px-4 uppercase font-semibold text-sm">Name</th><th class="w-1/4 text-left py-3 px-4 uppercase font-semibold text-sm">Category</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm">Image</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm">Rating</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm">Actions</th></tr></thead>
                            <tbody class="text-gray-700 dark:text-gray-200">${paginatedItems.map(item => `<tr><td class="text-left py-3 px-4">${item.name}</td><td class="text-left py-3 px-4">${item.category}</td><td class="text-left py-3 px-4"><img src="${item.image}" alt="${item.name}" class="h-12 w-12 object-cover rounded"></td><td class="text-left py-3 px-4">${'â˜…'.repeat(item.rating)}</td><td class="text-left py-3 px-4"><button data-id="${item.id}" class="edit-button bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 mr-2">Edit</button><button data-id="${item.id}" class="delete-button bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Delete</button></td></tr>`).join('') || `<tr><td colspan="5" class="text-center py-4">No items found.</td></tr>`}</tbody>
                        </table>
                    </div>
                    <!-- Pagination Controls -->
                    <div id="pagination-controls" class="mt-4 flex justify-center"></div>`;

                // --- Add Event Listeners to new elements ---
                document.getElementById('add-new-button').addEventListener('click', () => handleOpenModal());
                document.getElementById('search-input').addEventListener('input', (e) => { appState.searchTerm = e.target.value; appState.currentPageNumber = 1; renderListPage(); });
                document.getElementById('filter-select').addEventListener('change', (e) => { appState.filterCategory = e.target.value; appState.currentPageNumber = 1; renderListPage(); });
                mainContent.querySelectorAll('.edit-button').forEach(btn => btn.addEventListener('click', (e) => handleOpenModal(parseInt(e.target.dataset.id))));
                mainContent.querySelectorAll('.delete-button').forEach(btn => btn.addEventListener('click', (e) => handleDeleteItem(parseInt(e.target.dataset.id))));
                
                // Export functionality
                const exportButton = document.getElementById('export-button');
                const exportOptions = document.getElementById('export-options');
                exportButton.addEventListener('click', () => exportOptions.classList.toggle('hidden'));
                document.getElementById('export-pdf').addEventListener('click', (e) => { e.preventDefault(); exportToPDF(allItems); });
                document.getElementById('export-excel').addEventListener('click', (e) => { e.preventDefault(); exportToExcel(allItems); });

                renderPagination(allItems.length);
            }

            /**
             * Renders pagination buttons based on the total number of items.
             * @param {number} totalItems The total number of items after filtering.
             */
            function renderPagination(totalItems) {
                const totalPages = Math.ceil(totalItems / appState.itemsPerPage);
                const paginationControls = document.getElementById('pagination-controls');
                if (totalPages <= 1) { paginationControls.innerHTML = ''; return; }
                let buttons = '';
                for (let i = 1; i <= totalPages; i++) { buttons += `<button data-page="${i}" class="pagination-button px-4 py-2 mx-1 border rounded ${i === appState.currentPageNumber ? 'bg-blue-500 text-white' : 'bg-white text-blue-500'}">${i}</button>`; }
                paginationControls.innerHTML = buttons;
                paginationControls.querySelectorAll('.pagination-button').forEach(btn => btn.addEventListener('click', (e) => { appState.currentPageNumber = parseInt(e.target.dataset.page); renderListPage(); }));
            }

            // --- DATA EXPORT FUNCTIONS ---
            function exportToPDF(items) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const tableColumn = Object.keys(items[0] || {});
                const tableRows = items.map(item => Object.values(item));

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                });
                doc.save(`${appState.currentPage}.pdf`);
            }

            function exportToExcel(items) {
                const worksheet = XLSX.utils.json_to_sheet(items);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, appState.currentPage);
                XLSX.writeFile(workbook, `${appState.currentPage}.xlsx`);
            }

            // --- MODAL & FORM HANDLING (GENERIC) ---
            let map, mapMarker; // Leaflet map instance

            /**
             * Opens and populates the Create/Edit modal.
             * @param {number|null} [id=null] The ID of the item to edit. If null, opens in 'create' mode.
             */
            function handleOpenModal(id = null) {
                appState.editingId = id;
                const pageKey = appState.currentPage;
                const singularTitle = pageKey.slice(0, -1);
                const item = id ? db[pageKey].find(d => d.id === id) : {};
                
                document.getElementById('modal-title').textContent = id ? `Edit ${item.name}` : `Add New ${singularTitle.charAt(0).toUpperCase() + singularTitle.slice(1)}`;
                
                document.getElementById('modal-form').innerHTML = `
                    <input type="hidden" name="id" value="${item.id || ''}">
                    <div class="mb-4"><label class="block text-gray-700 dark:text-gray-200 text-sm font-bold mb-2" for="name">Name</label><input class="shadow appearance-none border dark:border-gray-700 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-900" id="name" type="text" name="name" value="${item.name || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 dark:text-gray-200 text-sm font-bold mb-2" for="category">Category</label><input class="shadow appearance-none border dark:border-gray-700 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-900" id="category" type="text" name="category" value="${item.category || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 dark:text-gray-200 text-sm font-bold mb-2" for="image">Image</label><input class="shadow appearance-none border dark:border-gray-700 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-900" id="image-upload" type="file" accept="image/*"><img id="image-preview" src="${item.image || ''}" class="${item.image ? '' : 'hidden'} mt-2 h-24 w-auto rounded"><input type="hidden" name="image" value="${item.image || ''}"></div>
                    <div class="mb-4"><label class="block text-gray-700 dark:text-gray-200 text-sm font-bold mb-2" for="description">Description</label><textarea class="shadow appearance-none border dark:border-gray-700 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-900" id="description" name="description">${item.description || ''}</textarea></div>
                    <div class="mb-4"><label class="block text-gray-700 dark:text-gray-200 text-sm font-bold mb-2" for="rating">Rating</label><select class="shadow border dark:border-gray-700 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-900" id="rating" name="rating">${[1,2,3,4,5].map(r => `<option value="${r}" ${item.rating == r ? 'selected' : ''}>${'â˜…'.repeat(r)}</option>`).join('')}</select></div>
                    <div class="mb-4"><label class="block text-gray-700 dark:text-gray-200 text-sm font-bold mb-2">Coordinates</label><div id="map" class="h-64 w-full rounded border dark:border-gray-700"></div><div class="flex gap-4 mt-2"><input class="shadow appearance-none border dark:border-gray-700 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 bg-gray-200 dark:bg-gray-900" id="lat" type="text" name="lat" value="${item.lat || -8.4095}" readonly><input class="shadow appearance-none border dark:border-gray-700 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 bg-gray-200 dark:bg-gray-900" id="lng" type="text" name="lng" value="${item.lng || 115.1889}" readonly></div></div>
                    <div class="flex justify-end"><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button></div>`;
                
                modal.classList.remove('hidden'); modalContainer.classList.remove('-translate-y-full');
                
                // Add event listeners for the new form
                document.getElementById('modal-form').addEventListener('submit', handleFormSubmit);
                document.getElementById('image-upload').addEventListener('change', handleImagePreview);
                
                // Initialize the map
                initMap(item.lat || -8.4095, item.lng || 115.1889);
            }

            function handleCloseModal() { modalContainer.classList.add('-translate-y-full'); modal.classList.add('hidden'); if (map) { map.remove(); map = null; } }
            
            /**
             * Handles the file input change event to show an image preview and store it as a base64 string.
             */
            function handleImagePreview(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('image-preview');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        document.querySelector('input[name="image"]').value = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            /**
             * Handles the form submission for both create and update.
             */
            function handleFormSubmit(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const item = Object.fromEntries(formData.entries());

                item.id = appState.editingId;
                item.rating = parseInt(item.rating);
                item.lat = parseFloat(item.lat);
                item.lng = parseFloat(item.lng);

                if (appState.editingId) {
                    updateItem(item);
                } else {
                    addItem(item);
                }
                handleCloseModal();
            }
            
            function handleDeleteItem(id) { showConfirmation('Are you sure you want to delete this item? This action cannot be undone.', () => deleteItem(id)); }
            
            /**
             * Initializes the Leaflet map in the modal.
             */
            function initMap(lat, lng) { map = L.map('map').setView([lat, lng], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); mapMarker = L.marker([lat, lng], { draggable: true }).addTo(map); mapMarker.on('dragend', (e) => { const pos = e.target.getLatLng(); document.getElementById('lat').value = pos.lat.toFixed(4); document.getElementById('lng').value = pos.lng.toFixed(4); }); }

            // --- GENERIC CRUD (Create, Read, Update, Delete) FUNCTIONS ---
            // These functions interact with the 'db' object and simulate an API call with a delay.

            const addItem = (item) => { setLoading(true); setTimeout(() => { const items = db[appState.currentPage]; item.id = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1; items.push(item); setLoading(false); showToast('Item added successfully!'); render(); }, 500); };
            const updateItem = (updatedItem) => { setLoading(true); setTimeout(() => { const items = db[appState.currentPage]; const index = items.findIndex(item => item.id === updatedItem.id); if (index !== -1) items[index] = updatedItem; setLoading(false); showToast('Item updated successfully!'); render(); }, 500); };
            const deleteItem = (id) => { setLoading(true); setTimeout(() => { db[appState.currentPage] = db[appState.currentPage].filter(item => item.id !== id); setLoading(false); showToast('Item deleted successfully!', 'error'); render(); }, 500); };
            
            // --- INITIALIZATION & GLOBAL EVENT LISTENERS ---
            
            const mainContainer = document.getElementById('main-container');

            // Function to handle sidebar state
            const setSidebarState = (isOpen) => {
                if (isOpen) {
                    sidebar.classList.remove('-translate-x-full');
                    mainContainer.style.marginLeft = '16rem'; // w-64
                } else {
                    sidebar.classList.add('-translate-x-full');
                    mainContainer.style.marginLeft = '0';
                }
                localStorage.setItem('sidebarOpen', isOpen);
            };

            // Sidebar toggle for all screen sizes
            menuButton.addEventListener('click', () => {
                const isOpen = !sidebar.classList.contains('-translate-x-full');
                setSidebarState(!isOpen);
            });
            
            // Close modal button
            modalCloseButton.addEventListener('click', handleCloseModal);
            
            // Sidebar navigation
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    appState.currentPage = e.target.getAttribute('data-page');
                    render();
                    // On smaller screens, close sidebar after navigation
                    if (window.innerWidth < 768) {
                        setSidebarState(false);
                    }
                });
            });
            
            // Initial setup on page load
            const sidebarInitiallyOpen = localStorage.getItem('sidebarOpen') === 'true';
            setSidebarState(sidebarInitiallyOpen);

            // --- THEME TOGGLE ---
            const themeToggle = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-icon-dark');
            const lightIcon = document.getElementById('theme-icon-light');

            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    darkIcon.classList.remove('hidden');
                    lightIcon.classList.add('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    darkIcon.classList.add('hidden');
                    lightIcon.classList.remove('hidden');
                }
            };

            themeToggle.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
                // Re-render the current page to apply theme changes to dynamic content like charts
                render();
            });

            // Apply theme on initial load
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);

            // --- CHATBOT ---
            const chatbotToggle = document.getElementById('chatbot-toggle');
            const chatbotWindow = document.getElementById('chatbot-window');
            const chatbotMessages = document.getElementById('chatbot-messages');
            const chatbotInput = document.getElementById('chatbot-input');
            const chatbotSend = document.getElementById('chatbot-send');

            chatbotToggle.addEventListener('click', () => {
                chatbotWindow.classList.toggle('hidden');
            });

            const addMessage = (sender, text) => {
                const messageEl = document.createElement('div');
                messageEl.className = `p-3 rounded-lg max-w-[80%] mb-2 ${sender === 'user' ? 'message-user self-end' : 'message-bot self-start'}`;
                messageEl.textContent = text;
                chatbotMessages.appendChild(messageEl);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            };

            const getAIResponse = async (userInput) => {
                // System prompt to guide the AI
                const systemPrompt = `You are a helpful admin assistant for a tourism website's admin panel.
                Your goal is to help the admin manage their data efficiently.
                The available data is stored in a JavaScript object called 'db'.
                The 'db' object has the following keys: 'destinations', 'hotels', 'foods', 'traditions', 'bookings', 'users', and 'analytics'.
                
                Based on the user's request, you can perform the following actions:
                1.  **Summarize Data:** If the user asks for a summary (e.g., "summarize users"), provide a concise overview. For users, mention the total count and how many are active vs. inactive. For bookings, mention the total count.
                2.  **Count Items:** If the user asks "how many" (e.g., "how many hotels are there?"), provide the total count for that data type.
                3.  **Provide Guidance:** If the user asks for help (e.g., "how do I add a new destination?"), explain the steps: "Click on the 'Destinations' page, then click the 'Add New' button."
                4.  **Answer General Questions:** Answer general questions politely.

                Keep your responses brief and to the point.`;

                // Simulate an AI call by interpreting the user's intent.
                // In a real application, you would send the systemPrompt and userInput to an LLM.
                const lowerInput = userInput.toLowerCase();
                
                if (lowerInput.includes('summarize users')) {
                    const active = db.users.filter(u => u.status === 'Active').length;
                    return `There are ${db.users.length} users in total. ${active} are active, and ${db.users.length - active} are inactive.`;
                } else if (lowerInput.includes('how many hotels')) {
                    return `There are ${db.hotels.length} hotels.`;
                } else if (lowerInput.includes('how do i add')) {
                    return "To add a new item, navigate to the relevant page from the sidebar and click the 'Add New' button.";
                } else if (lowerInput.includes('summarize bookings')) {
                    return `There are currently ${db.bookings.length} bookings recorded.`;
                } else {
                    return "I can help with summarizing data (e.g., 'summarize users') or providing guidance (e.g., 'how do I add a hotel?'). How can I assist you?";
                }
            };

            const handleSendMessage = async () => {
                const text = chatbotInput.value.trim();
                if (!text) return;

                addMessage('user', text);
                chatbotInput.value = '';
                
                const aiResponse = await getAIResponse(text);
                addMessage('bot', aiResponse);
            };

            chatbotSend.addEventListener('click', handleSendMessage);
            chatbotInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSendMessage();
            });

            addMessage('bot', 'Hello! How can I assist you with managing the admin panel today?');

            render();
        });
    </script>
</body>
</html>
