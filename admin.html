<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Tailwind CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- LeafletJS CSS from CDN for the map picker -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Custom CSS for transitions and minor tweaks */
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-hidden { transform: translateX(-100%); }
        .modal-overlay, .toast { transition: opacity 0.3s ease-in-out; }
        .modal-container { transition: transform 0.3s ease-in-out; }
        .toast-enter { opacity: 0; transform: translateY(20px); }
        .toast-leave { opacity: 0; transform: translateY(-20px); }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Main application container -->
    <div class="flex h-screen bg-gray-200">
        <!-- Collapsible Sidebar -->
        <div id="sidebar" class="w-64 bg-gray-800 text-white p-4 fixed inset-y-0 left-0 z-50 sidebar md:relative md:translate-x-0 sidebar-hidden">
            <h2 class="text-2xl font-bold mb-4">Admin Panel</h2>
            <nav>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-page="destinations">Destinations</a>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-page="hotels">Hotels</a>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-page="foods">Foods</a>
                <a href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-page="traditions">Traditions</a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="flex justify-between items-center p-4 bg-white border-b-2 border-gray-200">
                <div class="flex items-center">
                    <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden" aria-label="Open menu">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                    <h1 class="text-2xl font-bold text-gray-800 ml-4" id="page-title">Destinations</h1>
                </div>
            </header>
            <!-- Main content rendered by JavaScript -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4" id="main-content"></main>
        </div>
    </div>

    <!-- Reusable UI Components -->

    <!-- Modal for Create/Edit operations -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden modal-overlay"><div class="fixed inset-0 flex items-center justify-center p-4"><div id="modal-container" class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform -translate-y-full"><div class="flex justify-between items-center p-4 border-b"><h3 class="text-2xl font-bold" id="modal-title"></h3><button id="modal-close-button" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div class="p-6 overflow-y-auto" style="max-height: 80vh;"><form id="modal-form"></form></div></div></div></div>

    <!-- Confirmation Dialog for delete operations -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden modal-overlay"><div class="fixed inset-0 flex items-center justify-center p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm"><div class="p-6"><h3 class="text-xl font-bold mb-4" id="confirmation-title">Are you sure?</h3><p id="confirmation-message"></p></div><div class="flex justify-end gap-4 p-4 bg-gray-100 rounded-b-lg"><button id="confirmation-cancel-button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button><button id="confirmation-confirm-button" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Confirm</button></div></div></div></div>

    <!-- Container for Toast Notifications -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <!-- Loading State Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-25 z-50 hidden items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div></div>

    <!-- LeafletJS for map picker -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Wait for the DOM to be fully loaded before running the script
        document.addEventListener('DOMContentLoaded', () => {

            // --- DATA STRUCTURE & STORAGE ---
            // This 'db' object simulates a backend database. All data is stored in local memory.
            // In a real application, you would fetch this data from an API.
            // Each key ('destinations', 'hotels', etc.) corresponds to a page and a data table.
            // To add or modify fields, simply update the objects within these arrays.
            // For example, to add a 'price' field to destinations, you would change:
            // { id: 1, name: "Uluwatu Temple", ... }
            // to:
            // { id: 1, name: "Uluwatu Temple", price: 50000, ... }
            // Then, you would need to update the `renderListPage` function to display the new field
            // in the table and the `handleOpenModal` function to add a form input for it.
            const db = {
                destinations: [
                    { id: 1, name: "Uluwatu Temple", category: "Culture", image: "https://images.unsplash.com/photo-1537996194471-e657df975ab4?w=800", description: "A beautiful temple on a cliff.", rating: 5, lat: -8.829, lng: 115.085 },
                    { id: 2, name: "Seminyak Beach", category: "Beach", image: "https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=800", description: "Popular beach with great nightlife.", rating: 4, lat: -8.692, lng: 115.166 }
                ],
                hotels: [
                    { id: 1, name: "The Mulia Bali", category: "Resort", image: "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=800", description: "Luxurious resort in Nusa Dua.", rating: 5, lat: -8.805, lng: 115.223 },
                    { id: 2, name: "Four Seasons Sayan", category: "Luxury", image: "https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800", description: "Jungle paradise in Ubud.", rating: 5, lat: -8.508, lng: 115.244 }
                ],
                foods: [
                    { id: 1, name: "Babi Guling", category: "Traditional", image: "https://images.ctfassets.net/dsbipkqphva2/72JUsAlJ4IMn0Lsi7vpvEz/36de9180b101d808630599eadce4f40c/best-babi-guling-bali-lead.jpg", description: "Suckling pig, a Balinese delicacy.", rating: 5, lat: -8.653, lng: 115.217 }
                ],
                traditions: [
                    { id: 1, name: "Nyepi", category: "Ceremony", image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwZuVOXAw9ZVPGSVJSXT61HOCzym62sDL5UA&s", description: "The Balinese Day of Silence.", rating: 5, lat: -8.671, lng: 115.212 }
                ]
            };

            // --- APPLICATION STATE ---
            // This object holds the current UI state. It helps manage things like the active page,
            // search terms, and pagination, keeping the logic separate from the DOM.
            const appState = {
                currentPage: 'destinations',
                searchTerm: '',
                filterCategory: '',
                currentPageNumber: 1,
                itemsPerPage: 5,
                editingId: null, // Holds the ID of the item being edited, or null for creating new
            };

            // --- DOM ELEMENT REFERENCES ---
            // Caching DOM elements for quicker access.
            const sidebar = document.getElementById('sidebar'), menuButton = document.getElementById('menu-button'), navLinks = document.querySelectorAll('#sidebar nav a'), pageTitle = document.getElementById('page-title'), mainContent = document.getElementById('main-content'), modal = document.getElementById('modal'), modalContainer = document.getElementById('modal-container'), modalCloseButton = document.getElementById('modal-close-button');

            // --- UI COMPONENT FUNCTIONS ---

            /**
             * Displays a toast notification at the bottom-right of the screen.
             * @param {string} message The text to display in the toast.
             * @param {string} [type='success'] The type of toast ('success' or 'error'), which determines its color.
             */
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast text-white px-6 py-3 rounded-lg shadow-md mb-2 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} toast-enter`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.remove('toast-enter'), 10);
                setTimeout(() => {
                    toast.classList.add('toast-leave');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            /**
             * Shows a modal confirmation dialog.
             * @param {string} message The message to display in the dialog.
             * @param {function} onConfirm A callback function to execute if the user clicks "Confirm".
             */
            function showConfirmation(message, onConfirm) {
                const modal = document.getElementById('confirmation-modal');
                document.getElementById('confirmation-message').textContent = message;
                modal.classList.remove('hidden');

                const confirmButton = document.getElementById('confirmation-confirm-button');
                const cancelButton = document.getElementById('confirmation-cancel-button');

                const handleConfirm = () => {
                    onConfirm();
                    cleanup();
                };

                const cleanup = () => {
                    modal.classList.add('hidden');
                    confirmButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', cleanup);
                };

                confirmButton.addEventListener('click', handleConfirm);
                cancelButton.addEventListener('click', cleanup);
            }

            /**
             * Toggles the visibility of the loading overlay.
             * @param {boolean} isLoading If true, shows the loader; if false, hides it.
             */
            function setLoading(isLoading){const o=document.getElementById('loading-overlay');o.classList.toggle('hidden',!isLoading);o.classList.toggle('flex',isLoading)}

            // --- GENERIC RENDERING LOGIC ---

            /**
             * The main render function. It clears the content and calls the page-specific renderer.
             */
            const render = () => {
                const pageKey = appState.currentPage;
                const title = pageKey.charAt(0).toUpperCase() + pageKey.slice(1);
                pageTitle.textContent = title;
                mainContent.innerHTML = ''; // Clear previous content

                // Reset filters when switching pages
                appState.searchTerm = ''; appState.filterCategory = ''; appState.currentPageNumber = 1;

                // Call the generic function to render the list page
                renderListPage();
            };

            /**
             * Renders the entire UI for the current page, including the header, search/filter controls,
             * the data table, and pagination. This function is generic and works for any data type.
             */
            function renderListPage() {
                const pageKey = appState.currentPage;
                const pageTitle = pageKey.charAt(0).toUpperCase() + pageKey.slice(1);

                // --- Filtering and Pagination Logic ---
                const allItems = db[pageKey]
                    .filter(item => item.name.toLowerCase().includes(appState.searchTerm.toLowerCase()))
                    .filter(item => appState.filterCategory === '' || item.category === appState.filterCategory);

                const paginatedItems = allItems.slice((appState.currentPageNumber - 1) * appState.itemsPerPage, appState.currentPageNumber * appState.itemsPerPage);
                const categories = [...new Set(db[pageKey].map(item => item.category))];

                // --- Dynamic HTML Generation ---
                mainContent.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 class="text-3xl font-bold">Manage ${pageTitle}</h2>
                        <button id="add-new-button" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add New</button>
                    </div>
                    <!-- Search and Filter Controls -->
                    <div class="flex flex-wrap gap-4 mb-4">
                        <input id="search-input" type="text" placeholder="Search by name..." class="p-2 border rounded w-full md:w-auto md:flex-grow" value="${appState.searchTerm}">
                        <select id="filter-select" class="p-2 border rounded w-full md:w-auto"><option value="">All Categories</option>${categories.map(c => `<option value="${c}" ${appState.filterCategory === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                    </div>
                    <!-- Data Table -->
                    <div class="bg-white shadow-md rounded overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-800 text-white"><tr><th class="w-1/3 text-left py-3 px-4 uppercase font-semibold text-sm">Name</th><th class="w-1/4 text-left py-3 px-4 uppercase font-semibold text-sm">Category</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm">Image</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm">Rating</th><th class="text-left py-3 px-4 uppercase font-semibold text-sm">Actions</th></tr></thead>
                            <tbody class="text-gray-700">${paginatedItems.map(item => `<tr><td class="text-left py-3 px-4">${item.name}</td><td class="text-left py-3 px-4">${item.category}</td><td class="text-left py-3 px-4"><img src="${item.image}" alt="${item.name}" class="h-12 w-12 object-cover rounded"></td><td class="text-left py-3 px-4">${'★'.repeat(item.rating)}</td><td class="text-left py-3 px-4"><button data-id="${item.id}" class="edit-button bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 mr-2">Edit</button><button data-id="${item.id}" class="delete-button bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Delete</button></td></tr>`).join('') || `<tr><td colspan="5" class="text-center py-4">No items found.</td></tr>`}</tbody>
                        </table>
                    </div>
                    <!-- Pagination Controls -->
                    <div id="pagination-controls" class="mt-4 flex justify-center"></div>`;

                // --- Add Event Listeners to new elements ---
                document.getElementById('add-new-button').addEventListener('click', () => handleOpenModal());
                document.getElementById('search-input').addEventListener('input', (e) => { appState.searchTerm = e.target.value; appState.currentPageNumber = 1; renderListPage(); });
                document.getElementById('filter-select').addEventListener('change', (e) => { appState.filterCategory = e.target.value; appState.currentPageNumber = 1; renderListPage(); });
                mainContent.querySelectorAll('.edit-button').forEach(btn => btn.addEventListener('click', (e) => handleOpenModal(parseInt(e.target.dataset.id))));
                mainContent.querySelectorAll('.delete-button').forEach(btn => btn.addEventListener('click', (e) => handleDeleteItem(parseInt(e.target.dataset.id))));

                renderPagination(allItems.length);
            }

            /**
             * Renders pagination buttons based on the total number of items.
             * @param {number} totalItems The total number of items after filtering.
             */
            function renderPagination(totalItems) {
                const totalPages = Math.ceil(totalItems / appState.itemsPerPage);
                const paginationControls = document.getElementById('pagination-controls');
                if (totalPages <= 1) { paginationControls.innerHTML = ''; return; }
                let buttons = '';
                for (let i = 1; i <= totalPages; i++) { buttons += `<button data-page="${i}" class="pagination-button px-4 py-2 mx-1 border rounded ${i === appState.currentPageNumber ? 'bg-blue-500 text-white' : 'bg-white text-blue-500'}">${i}</button>`; }
                paginationControls.innerHTML = buttons;
                paginationControls.querySelectorAll('.pagination-button').forEach(btn => btn.addEventListener('click', (e) => { appState.currentPageNumber = parseInt(e.target.dataset.page); renderListPage(); }));
            }

            // --- MODAL & FORM HANDLING (GENERIC) ---
            let map, mapMarker; // Leaflet map instance

            /**
             * Opens and populates the Create/Edit modal.
             * @param {number|null} [id=null] The ID of the item to edit. If null, opens in 'create' mode.
             */
            function handleOpenModal(id = null) {
                appState.editingId = id;
                const pageKey = appState.currentPage;
                const singularTitle = pageKey.slice(0, -1);
                const item = id ? db[pageKey].find(d => d.id === id) : {};

                document.getElementById('modal-title').textContent = id ? `Edit ${item.name}` : `Add New ${singularTitle.charAt(0).toUpperCase() + singularTitle.slice(1)}`;
                // --- Dynamically generate form fields ---
                document.getElementById('modal-form').innerHTML = `
                    <input type="hidden" name="id" value="${item.id || ''}">
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="name">Name</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="name" type="text" name="name" value="${item.name || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="category">Category</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="category" type="text" name="category" value="${item.category || ''}" required></div>
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="image">Image</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="image-upload" type="file" accept="image/*"><img id="image-preview" src="${item.image || ''}" class="${item.image ? '' : 'hidden'} mt-2 h-24 w-auto rounded"><input type="hidden" name="image" value="${item.image || ''}"></div>
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="description">Description</label><textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="description" name="description">${item.description || ''}</textarea></div>
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="rating">Rating</label><select class="shadow border rounded w-full py-2 px-3 text-gray-700" id="rating" name="rating">${[1,2,3,4,5].map(r => `<option value="${r}" ${item.rating == r ? 'selected' : ''}>${'★'.repeat(r)}</option>`).join('')}</select></div>
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Coordinates</label><div id="map" class="h-64 w-full rounded border"></div><div class="flex gap-4 mt-2"><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-gray-200" id="lat" type="text" name="lat" value="${item.lat || -8.4095}" readonly><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-gray-200" id="lng" type="text" name="lng" value="${item.lng || 115.1889}" readonly></div></div>
                    <div class="flex justify-end"><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button></div>`;

                // Show modal with animation
                modal.classList.remove('hidden'); modalContainer.classList.remove('-translate-y-full');

                // Add event listeners for the new form
                document.getElementById('modal-form').addEventListener('submit', handleFormSubmit);
                document.getElementById('image-upload').addEventListener('change', handleImagePreview);

                // Initialize the map
                initMap(item.lat || -8.4095, item.lng || 115.1889);
            }

            function handleCloseModal() { modalContainer.classList.add('-translate-y-full'); modal.classList.add('hidden'); if (map) { map.remove(); map = null; } }

            /**
             * Handles the file input change event to show an image preview and store it as a base64 string.
             */
            function handleImagePreview(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('image-preview');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        document.querySelector('input[name="image"]').value = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            /**
             * Handles the form submission for both create and update.
             */
            function handleFormSubmit(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const item = Object.fromEntries(formData.entries());

                item.id = appState.editingId;
                item.rating = parseInt(item.rating);
                item.lat = parseFloat(item.lat);
                item.lng = parseFloat(item.lng);

                if (appState.editingId) {
                    updateItem(item);
                } else {
                    addItem(item);
                }
                handleCloseModal();
            }

            function handleDeleteItem(id) { showConfirmation('Are you sure you want to delete this item? This action cannot be undone.', () => deleteItem(id)); }

            /**
             * Initializes the Leaflet map in the modal.
             */
            function initMap(lat, lng) { map = L.map('map').setView([lat, lng], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); mapMarker = L.marker([lat, lng], { draggable: true }).addTo(map); mapMarker.on('dragend', (e) => { const pos = e.target.getLatLng(); document.getElementById('lat').value = pos.lat.toFixed(4); document.getElementById('lng').value = pos.lng.toFixed(4); }); }

            // --- GENERIC CRUD (Create, Read, Update, Delete) FUNCTIONS ---
            // These functions interact with the 'db' object and simulate an API call with a delay.

            const addItem = (item) => { setLoading(true); setTimeout(() => { const items = db[appState.currentPage]; item.id = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1; items.push(item); setLoading(false); showToast('Item added successfully!'); render(); }, 500); };
            const updateItem = (updatedItem) => { setLoading(true); setTimeout(() => { const items = db[appState.currentPage]; const index = items.findIndex(item => item.id === updatedItem.id); if (index !== -1) items[index] = updatedItem; setLoading(false); showToast('Item updated successfully!'); render(); }, 500); };
            const deleteItem = (id) => { setLoading(true); setTimeout(() => { db[appState.currentPage] = db[appState.currentPage].filter(item => item.id !== id); setLoading(false); showToast('Item deleted successfully!', 'error'); render(); }, 500); };

            // --- INITIALIZATION & GLOBAL EVENT LISTENERS ---

            // Sidebar toggle for mobile
            menuButton.addEventListener('click', () => sidebar.classList.toggle('sidebar-hidden'));

            // Close modal button
            modalCloseButton.addEventListener('click', handleCloseModal);

            // Sidebar navigation
            navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); appState.currentPage = e.target.getAttribute('data-page'); render(); if (window.innerWidth < 768) sidebar.classList.add('sidebar-hidden'); }); });

            // Initial render on page load
            render();
        });
    </script>
</body>
</html>